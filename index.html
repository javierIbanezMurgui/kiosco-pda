<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema PDA — Control de Producción</title>
    <style>
        :root {
            --primary: #007bff;
            --danger: #dc3545;
            --success: #28a745;
            --bg: #f4f7f6;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
        }

        .container {
            height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
            box-sizing: border-box;
        }

        .card {
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%; max-width: 400px; text-align: center;
        }

        #pdaLabel { font-size: 22px; margin-bottom: 20px; color: #444; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }

        input {
            width: 100%; padding: 15px; margin: 10px 0;
            border: 1px solid #ddd; border-radius: 8px; font-size: 18px;
            box-sizing: border-box;
        }

        button {
            width: 100%; padding: 15px; margin: 10px 0;
            border: none; border-radius: 8px; font-size: 18px;
            font-weight: bold; cursor: pointer; transition: 0.3s;
            background-color: var(--primary); color: white;
        }

        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-logout { background-color: var(--danger); margin-top: 30px; }
        .btn-app { background-color: #6c757d; }

        #menuDiv { display: none; width: 100%; max-width: 500px; }
        .error { color: var(--danger); font-size: 14px; margin-top: 10px; min-height: 20px; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="card" id="mainCard">
        <h2 id="pdaLabel">Identificando PDA...</h2>
        <div id="loader" class="loading-spinner"></div>

        <div id="loginDiv">
            <input type="text" id="usuario" placeholder="Usuario Operario">
            <input type="password" id="pin" placeholder="PIN de Acceso" inputmode="numeric">
            <button id="loginButton" onclick="login()">INGRESAR AL TURNO</button>
            <p id="errorMsg" class="error"></p>
        </div>

        <div id="menuDiv">
            <h3 style="color: var(--success);">✔ Sesión Activa</h3>
            <p id="userInfo" style="font-weight: bold;"></p>
            <hr>
            <button class="btn-app" onclick="abrirApp('com.tuempresa.sga')">ABRIR SGA</button>
            <button class="btn-app" onclick="abrirApp('com.android.camera')">CÁMARA</button>
            <button class="btn-app" onclick="abrirURL('https://miempresa.com/dashboard')">DASHBOARD WEB</button>
            
            <button class="btn-logout" onclick="cerrarTurno()">FINALIZAR TURNO</button>
        </div>
    </div>
</div>

<script>
// ===== CONFIGURACIÓN SHEETY (REEMPLAZA ESTO) =====
const API_ID = "TU_API_ID_AQUI"; // Ejemplo: 7b8e...
const BASE_URL = `https://api.sheety.co/${API_ID}/kioscoPdas`;

const ENDPOINTS = {
    dispositivos: `${BASE_URL}/dispositivos`,
    usuarios: `${BASE_URL}/usuarios`,
    login: `${BASE_URL}/login`,
    logout: `${BASE_URL}/logout`
};

let NUMERO_PDA = null;
let DEVICE_ID_REAL = "NO_FULLY";
let DATOS_USUARIO = null;

// ===== DETECCIÓN DE HARDWARE =====
function getDeviceId() {
    if (typeof FullyKiosk !== "undefined") {
        return FullyKiosk.getDeviceId();
    }
    return "BROWSER_TEST_123"; // ID para pruebas en PC
}

// ===== INICIO AL CARGAR =====
async function inicializar() {
    DEVICE_ID_REAL = getDeviceId();
    const loader = document.getElementById("loader");
    loader.style.display = "block";

    try {
        const res = await fetch(ENDPOINTS.dispositivos);
        const data = await res.json();
        const dispositivo = data.dispositivos.find(d => d.device === DEVICE_ID_REAL);

        if (dispositivo) {
            NUMERO_PDA = dispositivo.numeroPda;
            document.getElementById("pdaLabel").innerText = "PDA Nº " + NUMERO_PDA;
        } else {
            throw new Error("Dispositivo no registrado en sistema.");
        }
    } catch (err) {
        document.getElementById("pdaLabel").innerText = "ERROR DE ACCESO";
        mostrarError("Esta PDA no está autorizada. ID: " + DEVICE_ID_REAL);
        document.getElementById("loginButton").disabled = true;
    } finally {
        loader.style.display = "none";
    }
}

// ===== LÓGICA DE LOGIN =====
async function login() {
    const userVal = document.getElementById('usuario').value.trim();
    const pinVal = document.getElementById('pin').value.trim();
    const errorElem = document.getElementById("errorMsg");

    if (!userVal || !pinVal) {
        mostrarError("Completa todos los campos");
        return;
    }

    try {
        document.getElementById("loginButton").disabled = true;
        const res = await fetch(ENDPOINTS.usuarios);
        const data = await res.json();
        
        const userFound = data.usuarios.find(u => u.usuario === userVal && String(u.pin) === pinVal);

        if (!userFound) {
            mostrarError("Usuario o PIN incorrectos");
            document.getElementById("loginButton").disabled = false;
            return;
        }

        DATOS_USUARIO = userFound;

        // Intentar obtener geolocalización antes de registrar
        navigator.geolocation.getCurrentPosition(
            (pos) => registrarYEntrar(pos.coords.latitude, pos.coords.longitude),
            () => registrarYEntrar(0, 0) // Entra aunque falle GPS
        );

    } catch (err) {
        mostrarError("Error de conexión con el servidor");
        document.getElementById("loginButton").disabled = false;
    }
}

async function registrarYEntrar(lat, lon) {
    await fetch(ENDPOINTS.login, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            login: {
                usuario: DATOS_USUARIO.usuario,
                numeroPda: NUMERO_PDA,
                device: DEVICE_ID_REAL,
                fecha: new Date().toLocaleString(),
                lat: lat,
                lon: lon
            }
        })
    });

    document.getElementById("loginDiv").style.display = "none";
    document.getElementById("menuDiv").style.display = "block";
    document.getElementById("userInfo").innerText = "Operario: " + DATOS_USUARIO.usuario;
}

// ===== FUNCIONES DE NAVEGACIÓN (COMPATIBILIDAD FREE) =====
function abrirApp(packageName) {
    if (typeof FullyKiosk !== "undefined") {
        // Intenta usar el bridge de Fully (si está activo en la config)
        FullyKiosk.launchApp(packageName);
    } else {
        // Fallback para navegadores estándar si es posible
        console.log("Intentando abrir app: " + packageName);
    }
}

function abrirURL(url) {
    location.href = url;
}

async function cerrarTurno() {
    if(!confirm("¿Deseas finalizar tu turno?")) return;

    navigator.geolocation.getCurrentPosition(async (pos) => {
        await fetch(ENDPOINTS.logout, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                logout: {
                    usuario: DATOS_USUARIO.usuario,
                    numeroPda: NUMERO_PDA,
                    fecha: new Date().toLocaleString(),
                    lat: pos.coords.latitude,
                    lon: pos.coords.longitude
                }
            })
        });
        location.reload(); // Reinicia la app para el siguiente operario
    });
}

function mostrarError(msg) {
    document.getElementById("errorMsg").innerText = msg;
}

window.onload = inicializar;
</script>

</body>
</html>
