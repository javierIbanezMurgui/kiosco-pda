<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema PDA — Producción</title>
    <style>
        :root { --primary: #007bff; --danger: #dc3545; --success: #28a745; --bg: #ffffff; }
        html, body { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            overflow: hidden; font-family: sans-serif;
            background-color: var(--bg) !important; 
        }
        .container { 
            height: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; padding: 20px; 
            box-sizing: border-box; position: relative; z-index: 10;
            background-color: var(--bg) !important;
        }
        .logo-container { margin-bottom: 20px; text-align: center; }
        .logo-img { max-width: 150px; height: auto; display: block; margin: 0 auto; }
        .card { 
            background: white; padding: 30px; border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; 
            max-width: 400px; text-align: center; border: 1px solid #eaeaea; 
        }
        #pdaLabel { font-size: 22px; margin-bottom: 20px; color: #333; font-weight: bold; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 18px; box-sizing: border-box; background-color: #f9f9f9; }
        button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; background-color: var(--primary); color: white; }
        button:disabled { background-color: #ccc; }
        #menuDiv { display: none; }
        .error { color: var(--danger); font-size: 14px; font-weight: bold; margin-top: 15px; background-color: #f8d7da; padding: 10px; border-radius: 5px; display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-container">
        <img src="aza-logistics.png" alt="Logo" class="logo-img" id="companyLogo" onerror="this.src='https://via.placeholder.com/150x50?text=LOGO+PENDIENTE'">
    </div>

    <div class="card">
        <div id="pdaLabel">Iniciando sistema...</div>
        <div id="loader" class="loader"></div>

        <div id="loginDiv">
            <input type="text" id="usuario" placeholder="Usuario Operario">
            <input type="password" id="pin" placeholder="PIN" inputmode="numeric">
            <button id="loginButton" onclick="login()" disabled>INGRESAR AL TURNO</button>
            <p id="errorMsg" class="error"></p>
        </div>

        <div id="menuDiv">
            <h3 id="userTag" style="color: var(--success);">Sesión Activa</h3>
            <button onclick="abrirApp('https://play.google.com/store/apps/details?id=com.whatsapp')">ABRIR CD MUELLES</button>
            <button onclick="abrirApp('com.whatsapp')">ABRIR GALERIA</button>
            <button onclick="abrirApp('com.tuempresa.sga')">ABRIR WHALES</button>
            <button onclick="abrirApp('com.tuempresa.sga')">ABRIR WHALES_RECEPCION</button>
            <button onclick="abrirApp('com.tuempresa.sga')">ABRIR CAMARA</button>
            <button class="btn-logout" onclick="cerrarTurno()" style="background-color: var(--danger);">CERRAR TURNO</button>
        </div>
    </div>
</div>

<script>
const URL_USUARIOS = "https://api.sheety.co/9389b56cb6358dbc85be664d0e548b76/kioscoPdas/usuarios";
const URL_DISPOSITIVOS = "https://api.sheety.co/9389b56cb6358dbc85be664d0e548b76/kioscoPdas/dispositivos";
const URL_LOGIN = "https://api.sheety.co/9389b56cb6358dbc85be664d0e548b76/kioscoPdas/login";
const URL_LOGOUT = "https://api.sheety.co/9389b56cb6358dbc85be664d0e548b76/kioscoPdas/logout";

let NUMERO_PDA = null;
let DEVICE_ID_REAL = "NO_DETECTADO";
let USUARIO_ACTUAL = null;

function getDeviceId() {
    if (typeof fully !== "undefined" && fully.getDeviceId) return fully.getDeviceId();
    if (typeof FullyKiosk !== "undefined" && FullyKiosk.getDeviceId) return FullyKiosk.getDeviceId();
    return "PDA_TEST"; 
}

function mostrarError(msg) {
    const errorElem = document.getElementById("errorMsg");
    if (msg) { errorElem.innerText = msg; errorElem.style.display = "block"; }
    else { errorElem.style.display = "none"; }
}

async function inicializar() {
    DEVICE_ID_REAL = getDeviceId();
    document.getElementById("pdaLabel").innerText = "Conectando...";
    document.getElementById("loader").style.display = "block";

    try {
        const res = await fetch(`${URL_DISPOSITIVOS}?cb=${Date.now()}`);
        if (!res.ok) throw new Error("Error de Servidor (Sheety)");

        const data = await res.json();
        const pdaFound = data.dispositivos.find(d => String(d.device).trim() === String(DEVICE_ID_REAL).trim());

        if (pdaFound) {
            NUMERO_PDA = pdaFound.numeroPda;
            document.getElementById("pdaLabel").innerText = "PDA Nº " + NUMERO_PDA;
            document.getElementById("loginButton").disabled = false;
        } else {
            document.getElementById("pdaLabel").innerText = "SIN REGISTRO";
            mostrarError("ID no autorizado: " + DEVICE_ID_REAL);
        }
    } catch (err) {
        document.getElementById("pdaLabel").innerText = "ERROR DE RED";
        mostrarError("¿Hay Wi-Fi? " + err.message);
    } finally {
        document.getElementById("loader").style.display = "none";
    }
}

async function login() {
    const u = document.getElementById("usuario").value.trim();
    const p = document.getElementById("pin").value.trim();
    if (!u || !p) return mostrarError("Faltan datos");

    try {
        const res = await fetch(URL_USUARIOS);
        const data = await res.json();
        const user = data.usuarios.find(x => x.usuario === u && String(x.pin) === p);

        if (user) {
            USUARIO_ACTUAL = user.usuario;
            document.getElementById("userTag").innerText = "Operario: " + USUARIO_ACTUAL;
            document.getElementById("loginDiv").style.display = "none";
            document.getElementById("menuDiv").style.display = "block";
            
            fetch(URL_LOGIN, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ login: { usuario: USUARIO_ACTUAL, numeroPda: NUMERO_PDA, device: DEVICE_ID_REAL, fecha: new Date().toLocaleString() } })
            });
        } else { mostrarError("Usuario o PIN incorrecto"); }
    } catch (e) { mostrarError("Error en login"); }
}

function abrirApp(pkg) {
    if (typeof fully !== "undefined") fully.launchApp(pkg);
    else if (typeof FullyKiosk !== "undefined") FullyKiosk.launchApp(pkg);
    else alert("Abriendo: " + pkg);
}

async function cerrarTurno() {
    if(!confirm("¿Deseas finalizar el turno y cerrar sesión?")) return;
    
    const label = document.getElementById("pdaLabel");
    label.innerText = "CERRANDO SESIÓN...";
    document.getElementById("menuDiv").style.display = "none";
    document.getElementById("loader").style.display = "block";

    try {
        // Enviamos los datos a la hoja de LOGOUT antes de recargar
        await fetch(URL_LOGOUT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                logout: { 
                    usuario: USUARIO_ACTUAL, 
                    numeroPda: NUMERO_PDA, 
                    device: DEVICE_ID_REAL, 
                    fecha: new Date().toLocaleString() 
                } 
            })
        });
        console.log("Cierre de sesión registrado en Sheety");
    } catch(e) { 
        console.error("Error al registrar logout:", e); 
        alert("Error de red al cerrar turno, pero se reiniciará la sesión.");
    } finally {
        // Solo recargamos cuando el envío ha terminado (o ha fallado)
        location.reload(); 
    }
}

// Esperamos 1 segundo para que la tablet cargue sus funciones internas
window.onload = () => { setTimeout(inicializar, 1000); };
</script>
</body>
</html>
