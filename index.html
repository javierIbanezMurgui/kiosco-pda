<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sistema PDA — Login Controlado</title>
<style>
/* ===== PANTALLA COMPLETA ===== */
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
}

.container {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

input, button {
    width: 80%;
    max-width: 400px;
    font-size: 20px;
    padding: 10px;
    margin: 5px 0;
}

button {
    cursor: pointer;
}

#menuDiv { display: none; }
#pdaLabel { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px; }
.error { color: red; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
    <h2 id="pdaLabel">Cargando dispositivo...</h2>

    <div id="loginDiv">
        <input type="text" id="usuario" placeholder="Usuario">
        <input type="password" id="pin" placeholder="PIN">
        <button id="loginButton" onclick="login()">Ingresar</button>
        <p id="errorMsg" class="error"></p>
    </div>

    <div id="menuDiv">
        <h2>Sesión iniciada</h2>
        <p>Ahora puedes usar únicamente apps y URLs autorizadas</p>
        <button onclick="abrirSGA()">Abrir SGA</button>
        <button onclick="abrirCamara()">Abrir Cámara</button>
        <button onclick="abrirGaleria()">Abrir Galería</button>
        <button onclick="abrirURL('https://miempresa.com/dashboard')">Abrir URL</button>
        <br><br>
        <button onclick="cerrarTurno()">Cerrar Turno</button>
    </div>
</div>

<script>
// ===== CONFIGURA TU API =====
const BASE_URL = "https://api.sheety.co/9389b56cb6358dbc85be664d0e548b76/kioscoPdas";
const USERS_URL = BASE_URL + "/usuarios";
const DEVICE_URL = BASE_URL + "/dispositivos";
const LOGIN_URL = BASE_URL + "/login";
const LOGOUT_URL = BASE_URL + "/logout";

// ===== DEVICE ID =====
function getDeviceId(){
    if(typeof FullyKiosk !== "undefined"){
        return FullyKiosk.getDeviceId();
    } else {
        return "NO_FULLY";
    }
}

let NUMERO_PDA = null;
let DEVICE_VALIDO = false;

// ===== CARGAR NUMERO DE PDA =====
function cargarNumeroPDA() {
    fetch(DEVICE_URL)
    .then(res => res.json())
    .then(data => {
        const deviceId = getDeviceId();
        const lista = data.dispositivos;
        const dispositivo = lista.find(d => d.device === deviceId);

        if(dispositivo){
            NUMERO_PDA = dispositivo.numeroPda;
            DEVICE_VALIDO = true;
            document.getElementById("pdaLabel").innerText = "PDA Nº " + NUMERO_PDA;
        } else {
            DEVICE_VALIDO = false;
            document.getElementById("pdaLabel").innerText = "DISPOSITIVO NO REGISTRADO";
            document.getElementById("loginButton").disabled = true;
        }
    })
    .catch(()=>{
        document.getElementById("pdaLabel").innerText="Error conexión servidor";
    });
}

// ===== MOSTRAR ERROR =====
function mostrarError(msg){ document.getElementById("errorMsg").innerText = msg; }

// ===== LOGIN =====
function login(){
    if(!DEVICE_VALIDO) return;

    const usuario = document.getElementById('usuario').value.trim();
    const pin = document.getElementById('pin').value.trim();
    if(!usuario || !pin){ mostrarError("Ingrese usuario y PIN"); return; }

    fetch(USERS_URL)
    .then(res=>res.json())
    .then(data=>{
        const userValid = data.usuarios.find(u=>u.usuario===usuario && u.pin===pin);
        if(!userValid){ mostrarError("Usuario o PIN incorrecto"); return; }

        navigator.geolocation.getCurrentPosition(
            (position)=>{
                fetch(LOGIN_URL, {
                    method:"POST",
                    headers:{"Content-Type":"application/json"},
                    body: JSON.stringify({
                        login:{
                            usuario:usuario,
                            numeroPda:NUMERO_PDA,
                            device:getDeviceId(),
                            fecha:new Date().toISOString(),
                            lat:position.coords.latitude,
                            lon:position.coords.longitude
                        }
                    })
                });

                document.getElementById('loginDiv').style.display="none";
                document.getElementById('menuDiv').style.display="block";

            },
            ()=>mostrarError("No se pudo obtener ubicación"),
            { enableHighAccuracy:true }
        );
    });
}

// ===== BOTONES =====
function abrirSGA(){
    if(typeof FullyKiosk!=="undefined"){
        FullyKiosk.launchApp("com.tuempresa.sga");
    }
}

function abrirCamara(){
    if(typeof FullyKiosk!=="undefined"){
        FullyKiosk.launchApp("com.android.camera");
    }
}

function abrirGaleria(){
    if(typeof FullyKiosk!=="undefined"){
        FullyKiosk.launchApp("com.android.gallery3d");
    }
}

function abrirURL(url){
    if(typeof FullyKiosk!=="undefined"){
        FullyKiosk.loadUrl(url);
    }
}

// ===== CERRAR TURNO =====
function cerrarTurno(){
    navigator.geolocation.getCurrentPosition(
        (position)=>{
            fetch(LOGOUT_URL,{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body: JSON.stringify({
                    logout:{
                        numeroPda:NUMERO_PDA,
                        device:getDeviceId(),
                        fecha:new Date().toISOString(),
                        lat:position.coords.latitude,
                        lon:position.coords.longitude
                    }
                })
            });

            document.getElementById('menuDiv').style.display="none";
            document.getElementById('loginDiv').style.display="block";
        }
    );
}

// ===== FULLSCREEN =====
function goFullScreen(){
    const el = document.documentElement;
    if(el.requestFullscreen) el.requestFullscreen();
    else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    else if(el.msRequestFullscreen) el.msRequestFullscreen();
}

window.onload = function(){
    cargarNumeroPDA();
    goFullScreen();
};
</script>

</body>
</html>
